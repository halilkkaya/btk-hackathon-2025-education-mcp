{% extends "base.html" %}

{% block title %}Chat Geçmişi - Eğitim Asistanı{% endblock %}

{% block content %}
<div class="min-h-screen py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12 animate-fade-in">
            <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-6 floating-element">
                <i class="fas fa-history text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-4">Chat Geçmişi</h1>
            <p class="text-xl text-white/70">Geçmiş konuşmalarınızı görüntüleyin ve devam ettirin</p>
        </div>

        <!-- Actions Bar -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-4">
                <h2 class="text-2xl font-semibold text-white">Son Konuşmalar</h2>
                <span class="bg-white/10 text-white/70 px-3 py-1 rounded-full text-sm">
                    {{ chat_sessions|length if chat_sessions else 0 }} chat
                </span>
            </div>
            <button onclick="refreshChats()" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-medium py-2 px-4 rounded-xl transition-all duration-300 hover-lift">
                <i class="fas fa-sync-alt mr-2"></i>Yenile
            </button>
        </div>

        <!-- Chat List -->
        <div id="chatList" class="space-y-4 mb-12">
            {% if chat_sessions %}
                {% for chat in chat_sessions %}
                <div class="glass-effect rounded-2xl p-6 hover-lift animate-slide-up chat-item" data-session-id="{{ chat.session_id }}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 cursor-pointer" onclick="openChat('{{ chat.session_id }}')">
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-comments text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-white mb-2">{{ chat.session_name }}</h3>
                                    <div class="flex items-center space-x-4 text-white/60 text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-calendar mr-2"></i>
                                            <span>{{ chat.created_at.strftime('%d.%m.%Y %H:%M') if chat.created_at else 'Bilinmiyor' }}</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-clock mr-2"></i>
                                            <span>{{ chat.last_activity.strftime('%d.%m.%Y %H:%M') if chat.last_activity else 'Bilinmiyor' }}</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-message mr-2"></i>
                                            <span>{{ chat.message_count or 0 }} mesaj</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="openChat('{{ chat.session_id }}')" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white p-2 rounded-lg transition-all duration-300 hover-lift" title="Chat'i Aç">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button onclick="deleteChat('{{ chat.session_id }}', '{{ chat.session_name }}')" class="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white p-2 rounded-lg transition-all duration-300 hover-lift" title="Chat'i Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="glass-effect rounded-2xl p-12 text-center animate-fade-in">
                    <div class="w-24 h-24 bg-gradient-to-r from-gray-500/20 to-gray-600/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-comments text-4xl text-white/40"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-4">Henüz chat geçmişiniz yok</h3>
                    <p class="text-white/60 mb-6">İlk konuşmanızı başlatın ve eğitim asistanından yardım alın</p>
                    <a href="/chat" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover-lift inline-flex items-center">
                        <i class="fas fa-plus mr-2"></i>Yeni Chat Başlat
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Statistics -->
        <div class="grid md:grid-cols-3 gap-6 animate-fade-in">
            <div class="glass-effect rounded-2xl p-6 text-center hover-lift">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-comments text-2xl text-blue-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Toplam Chat</h3>
                <p class="text-3xl font-bold text-blue-400" id="totalChats">{{ chat_sessions|length if chat_sessions else 0 }}</p>
            </div>
            
            <div class="glass-effect rounded-2xl p-6 text-center hover-lift">
                <div class="w-16 h-16 bg-gradient-to-r from-green-500/20 to-emerald-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-message text-2xl text-green-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Toplam Mesaj</h3>
                <p class="text-3xl font-bold text-green-400" id="totalMessages">
                    {% if chat_sessions %}
                        {{ chat_sessions|sum(attribute='message_count') or 0 }}
                    {% else %}
                        0
                    {% endif %}
                </p>
            </div>
            
            <div class="glass-effect rounded-2xl p-6 text-center hover-lift">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-clock text-2xl text-purple-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Son Aktiflik</h3>
                <p class="text-lg text-purple-400" id="lastActivity">
                    {% if chat_sessions and chat_sessions[0].last_activity %}
                        {{ chat_sessions[0].last_activity.strftime('%d.%m.%Y %H:%M') }}
                    {% else %}
                        -
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom animations for chat items */
.chat-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.chat-item:hover {
    transform: translateY(-2px) scale(1.01);
}

/* Loading animation */
.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Fade in animation for new elements */
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Success notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    max-width: 300px;
    padding: 16px;
    border-radius: 12px;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification.success {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.3);
    color: rgb(34, 197, 94);
}

.notification.error {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: rgb(239, 68, 68);
}
</style>

<script>
function openChat(sessionId) {
    // Loading animation
    const button = event.target.closest('button');
    if (button) {
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner loading-spinner"></i>';
        button.disabled = true;
        
        setTimeout(() => {
            window.location.href = `/chat?session=${sessionId}`;
        }, 500);
    } else {
        window.location.href = `/chat?session=${sessionId}`;
    }
}

function deleteChat(sessionId, sessionName) {
    // Modern confirmation dialog
    if (confirm(`"${sessionName}" chat'ini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz.`)) {
        // Loading state
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner loading-spinner"></i>';
        button.disabled = true;
        
        // Delete request
        fetch(`/api/delete-chat/${sessionId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success notification
                showNotification('Chat başarıyla silindi!', 'success');
                
                // Remove chat item with animation
                const chatItem = document.querySelector(`[data-session-id="${sessionId}"]`);
                if (chatItem) {
                    chatItem.style.transform = 'translateX(100%)';
                    chatItem.style.opacity = '0';
                    setTimeout(() => {
                        chatItem.remove();
                        updateStats();
                        
                        // Check if no chats left
                        const remainingChats = document.querySelectorAll('.chat-item');
                        if (remainingChats.length === 0) {
                            showEmptyState();
                        }
                    }, 300);
                }
            } else {
                showNotification('Chat silinirken bir hata oluştu!', 'error');
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Bir hata oluştu!', 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
}

function updateStats() {
    // Update chat count
    const chatItems = document.querySelectorAll('.chat-item');
    const totalChatsElement = document.getElementById('totalChats');
    if (totalChatsElement) {
        totalChatsElement.textContent = chatItems.length;
    }
    
    // Update message count (simplified calculation)
    let totalMessages = 0;
    chatItems.forEach(item => {
        const messageText = item.querySelector('[data-message-count]');
        if (messageText) {
            const count = parseInt(messageText.textContent) || 0;
            totalMessages += count;
        }
    });
    
    const totalMessagesElement = document.getElementById('totalMessages');
    if (totalMessagesElement) {
        totalMessagesElement.textContent = totalMessages;
    }
}

function showNotification(message, type) {
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }
    }, 3000);
}

function showEmptyState() {
    const chatList = document.getElementById('chatList');
    chatList.innerHTML = `
        <div class="glass-effect rounded-2xl p-12 text-center animate-fade-in fade-in">
            <div class="w-24 h-24 bg-gradient-to-r from-gray-500/20 to-gray-600/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-comments text-4xl text-white/40"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-4">Henüz chat geçmişiniz yok</h3>
            <p class="text-white/60 mb-6">İlk konuşmanızı başlatın ve eğitim asistanından yardım alın</p>
            <a href="/chat" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover-lift inline-flex items-center">
                <i class="fas fa-plus mr-2"></i>Yeni Chat Başlat
            </a>
        </div>
    `;
}

function refreshChats() {
    // Loading animation
    const refreshBtn = document.querySelector('button[onclick="refreshChats()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner loading-spinner mr-2"></i>Yenileniyor...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add entrance animations to chat items
    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach((item, index) => {
        item.style.animationDelay = `${index * 0.1}s`;
        item.classList.add('animate-slide-up');
    });
});
</script>
{% endblock %} 